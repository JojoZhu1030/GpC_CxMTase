---
title: "Binding_Assay_Scrambled"
author: "Jojo Zhu"
date: "2025-07-11"
output: html_document
---


```{r}
# Load libraries
library(ggplot2)
library(dplyr)
library(readr)

# Define reference sequence (100 bp)
ref_seq <- "ATTGCAGACCTTGTGGCAACAATTTCTAGATGCCTGCGGATGCAGTGTGCGCAACATGCATCAATTCTGGCTCAGAGCATATTGACTATCCGGTATTACC"
bases <- strsplit(ref_seq, "")[[1]]
positions <- 1:length(bases)
ref_df <- data.frame(pos = positions, base = bases)

```

```{r}
# Loop over sample IDs 
for (i in c(1:5, 11:15)) {
  
  sample_id <- paste0(i, "_S", i)
  cov_file <- paste0("scramble_cov/", sample_id, ".cov")
  
  # Load and preprocess .cov file
  cov_df <- read_tsv(cov_file, col_names = FALSE, show_col_types = FALSE)
  colnames(cov_df) <- c("chr", "start", "end", "percent", "unmod", "mod")
  
  cov_df <- cov_df %>%
    mutate(pos = start - 5) %>%  # adjust for 5bp padding
    filter(pos >= 1, pos <= 100) %>%
    left_join(ref_df, by = "pos") %>%
    filter(base %in% c("C", "G")) %>%
    mutate(
      strand = ifelse(base == "C", "+", "-"),
      height = ifelse(strand == "+", percent, -percent),
      strand = factor(strand, levels = c("+", "-"))
    )
  
  # Plot
  p <- ggplot(cov_df, aes(x = pos, y = height, fill = strand)) +
    geom_bar(stat = "identity", width = 0.6) +
    scale_fill_manual(values = c("+" = "steelblue", "-" = "tomato")) +
    scale_x_continuous(
      breaks = positions,
      labels = bases,
      expand = c(0.01, 0.01)
    ) +
    scale_y_continuous(labels = function(x) abs(x), limits = c(-100, 100)) +
    labs(
      x = "Position in 100 bp sequence",
      y = "Methylation (%)",
      title = paste("Strand-specific cytosine methylation -", sample_id)
    ) +
    theme_minimal(base_size = 12) +
    theme(
      axis.text.x = element_text(family = "mono", size = 11, angle = 0, vjust = 1, hjust = 0.5),
      panel.grid.major.x = element_blank(),
      legend.position = "top"
    )
  
  print(p)  
  
  ggsave(filename = paste0("methylation_plot_", sample_id, ".png"), plot = p, width = 10, height = 4, dpi = 300)
}
```
  
```{r}
# for stacked wider and shorter plots: 
# Loop over sample IDs 
for (i in c(1:5, 11:15)) {
  
  sample_id <- paste0(i, "_S", i)
  cov_file <- paste0("scramble_cov/", sample_id, ".cov")
  
  # Load and preprocess .cov file
  cov_df <- read_tsv(cov_file, col_names = FALSE, show_col_types = FALSE)
  colnames(cov_df) <- c("chr", "start", "end", "percent", "unmod", "mod")
  
  cov_df <- cov_df %>%
    mutate(pos = start - 5) %>%  # adjust for 5bp padding
    filter(pos >= 1, pos <= 100) %>%
    left_join(ref_df, by = "pos") %>%
    filter(base %in% c("C", "G")) %>%
    mutate(
      strand = ifelse(base == "C", "+", "-"),
      height = ifelse(strand == "+", percent, -percent),
      strand = factor(strand, levels = c("+", "-"))
    )
  
# Plot
p <- ggplot(cov_df, aes(x = pos, y = height, fill = strand)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(
  data = cov_df %>% filter(abs(percent) >= 5),  # only label percent ≥ 5
  aes(
    x = pos,
    y = height * 0.97,
    label = round(abs(percent), 1)              # ← one decimal place
  ),
  size = 2.5,
  family = "mono"
  ) +
  scale_fill_manual(values = c("+" = "steelblue", "-" = "tomato")) +
  scale_x_continuous(
    breaks = positions,
    labels = bases,
    expand = c(0.05, 0.05)
  ) +
  scale_y_continuous(labels = function(x) abs(x), limits = c(-100, 100)) +
  labs(
    x = "Position in 100 bp sequence",
    y = "mod%",
    title = paste("Strand-specific cytosine methylation -", sample_id)
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(family = "mono", size = 11, angle = 0, vjust = 1, hjust = 0.5),
    panel.grid.major.x = element_blank(),
    legend.position = "top"
  )

  print(p)  
  
ggsave(
  filename = paste0("methylation_plot_", sample_id, ".png"),
  plot = p,
  width = 14,    
  height = 2,  
  dpi = 300,
  bg = "white"  
)

}
```
